# GitHub Actions workflow for building and testing a multi-module Maven (Spring Boot) project
# This pipeline is configured to run on Java 21 (Temurin) to align with Spring Boot 4 requirements.
# It checks out the code, sets up JDK, caches Maven dependencies, builds all modules, and runs tests.

name: Maven Build & Test

on:
  # Trigger the workflow on pushes to main and on pull requests targeting main.
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# TODO: add sonarcloud for code analysis
# TODO: add Copilot suggestion for code review

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1) Checkout the repository to the runner workspace.
      # actions/checkout@v6 supports sparse checkout, submodules, and LFS when configured; here we use defaults.
      - name: Checkout repository
        uses: actions/checkout@v6

      # 2) Set up JDK 21 (Temurin distribution).
      # Spring Boot 4 targets Java 21; this ensures Maven and the build toolchain use JDK 21.
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'   # Eclipse Temurin (Adoptium) is a widely adopted OpenJDK build.
          java-version: '21'        # Use Java 21 LTS.
          # cache: 'maven'          # Optional: enable built-in Maven cache via setup-java (can replace the manual cache step below).

      # 3) Cache Maven dependencies to speed up subsequent builds.
      # The cache key is derived from the OS and the hash of all pom.xml files, so any POM change invalidates the cache.
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # 4) Build all modules using Maven in batch mode.
      # Flags:
      # -B   ("--batch-mode"): run Maven without interactive prompts; recommended for CI.
      # -ntp ("--no-transfer-progress"): suppress dependency download progress bars to reduce log noise in CI.
      # The goal chain "clean install" ensures modules are cleaned and artifacts are built/installed to the local repo.
      - name: Build with Maven
        run: mvn -B -ntp clean install
        working-directory: ./

      # 5) Run unit tests explicitly (optional as "install" already runs tests unless -DskipTests is set).
      # Using -ntp again to keep logs concise; tests run with the configured surefire/failsafe plugins in the project.
      - name: Run tests
        run: mvn -ntp test
